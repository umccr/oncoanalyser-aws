plugins {
  id 'nf-amazon'
}

aws {
  batch {
    jobRole = '__BATCH_INSTANCE_ROLE__'
    cliPath = '/opt/awscliv2/bin/aws'
    volumes = '/scratch'
  }
}

process {
  executor = 'awsbatch'
  scratch = '/scratch/'

  // NOTE(SW): AWS Batch jobs can only run where there is allocatable memory present on the instances, and this amount
  // is never the total capacity since ECS reserves memory and the system also occpies several hundred MiB. See
  // https://docs.aws.amazon.com/batch/latest/userguide/memory-management.html
  // NOTE(SW): Anything less than a 2.GB buffer appears to prevent Batch jobs from running on target instances

  withName: 'STAR' {
    container = 'docker.io/scwatts/star:2.7.3a--0'

    queue = 'nextflow-task-8cpu_64gb'
    cpus = 8
    memory = 60.GB
  }

  withName: 'SAMTOOLS_SORT' {
    container = 'docker.io/scwatts/samtools:1.16.1--h6899075_1'

    queue = 'nextflow-task-4cpu_16gb'
    cpus = 4
    memory = 14.GB
  }

  withName: 'GATK4_MARKDUPLICATES' {
    container = 'docker.io/scwatts/gatk4:4.4.0.0--py36hdfd78af_0'

    queue = 'nextflow-task-2cpu_16gb'
    cpus = 1
    memory = 14.GB
  }

  withName: 'CUSTOM_DUMPSOFTWAREVERSIONS' {
    queue = 'nextflow-task-2cpu_16gb'
    cpus = 1
    memory = 14.GB
  }

}
