plugins {
  id 'nf-amazon'
}

fusion {
  enabled = true
}

wave {
  enabled = true
}

aws {
  batch {
    jobRole = '{{BATCH_INSTANCE_TASK_ROLE_ARN}}'
    volumes = '{{BATCH_VOLUME_MOUNT_POINT}}:/tmp/'
  }
}

params {

  max_fastq_records = 250000000

  genomes {
    GRCh38_hmf {
      fasta         = 's3://{{S3_BUCKET_NAME}}/{{S3_BUCKET_REFDATA_PREFIX}}/genomes/GRCh38_hmf/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna'
      fai           = 's3://{{S3_BUCKET_NAME}}/{{S3_BUCKET_REFDATA_PREFIX}}/genomes/GRCh38_hmf/samtools_index/1.16/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.fai'
      dict          = 's3://{{S3_BUCKET_NAME}}/{{S3_BUCKET_REFDATA_PREFIX}}/genomes/GRCh38_hmf/samtools_index/1.16/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.dict'
      img           = 's3://{{S3_BUCKET_NAME}}/{{S3_BUCKET_REFDATA_PREFIX}}/genomes/GRCh38_hmf/bwa_index_image/0.7.17-r1188/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.img'
      bwamem2_index = 's3://{{S3_BUCKET_NAME}}/{{S3_BUCKET_REFDATA_PREFIX}}/genomes/GRCh38_hmf/gridss_index/2.13.2/'
      gridss_index  = 's3://{{S3_BUCKET_NAME}}/{{S3_BUCKET_REFDATA_PREFIX}}/genomes/GRCh38_hmf/gridss_index/2.13.2/'
      star_index    = 's3://{{S3_BUCKET_NAME}}/{{S3_BUCKET_REFDATA_PREFIX}}/genomes/GRCh38_hmf/bwa-mem2_index/2.2.1/'
    }
  }

}

process {
  executor = 'awsbatch'
  scratch = false

  // NOTE(SW): using docker.runOptions in 23.10.01 causes `--network host` to be included twice, triggering an error in Docker
  containerOptions = '--network host'

  resourceLabels = {
    return [
      'Stack': 'OncoanalyserStack',
      'JobName': task.process,
    ]
  }

  queue = '{{BATCH_JOB_QUEUE_NAME}}'

  withName: 'FASTP' {
    queue = '{{FASTP_DOCKER_IMAGE_URI}}'
    cpus = 16
    memory = 30.GB
  }

  withName: 'BWAMEM2_ALIGN' {
    queue = '{{BWAMEM2_DOCKER_IMAGE_URI}}'
    cpus = 32
    memory = 60.GB
  }

  withName: 'REDUX' {
    queue = '{{REDUX_DOCKER_IMAGE_URI}}'
    cpus = 16
    memory = 120.GB
  }

  withName: 'STAR_ALIGN' {
    queue = '{{_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 60.GB
  }

  withName: 'SAMTOOLS_SORT' {
    queue = '{{SAMTOOLS_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 30.GB
  }

  withName: 'SAMBAMBA_MERGE' {
    queue = '{{SAMBAMBA_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 30.GB
  }

  withName: 'GATK4_MARKDUPLICATES' {
    queue = '{{_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 30.GB
  }

  withName: 'AMBER' {
    queue = '{{AMBER_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 30.GB
  }

  withName: 'COBALT' {
    queue = '{{COBALT_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 30.GB
  }

  withName: 'ESVEE_PREP' {
    queue = '{{ESVEE_DOCKER_IMAGE_URI}}'
    errorStrategy = 'retry'
    maxRetries = 1

    cpus =   { task.attempt == 1 ? 16    : 8      }
    memory = { task.attempt == 1 ? 60.GB : 122.GB }
  }

  withName: 'ESVEE_PREP' {
    queue = '{{ESVEE_DOCKER_IMAGE_URI}}'
    errorStrategy = 'retry'
    maxRetries = 1

    time = 12.h

    cpus = 16
    memory = { task.attempt == 1 ? 30.GB : 122.GB }
  }

  withName: 'ESVEE_CALL' {
    queue = '{{ESVEE_DOCKER_IMAGE_URI}}'
    cpus = 16
    memory = 30.GB
  }

  withName: 'ESVEE_DEPTH_ANNOTATOR' {
    queue = '{{ESVEE_DOCKER_IMAGE_URI}}'
    errorStrategy = 'retry'
    maxRetries = 1

    cpus =   { task.attempt == 1 ? 16    : 8      }
    memory = { task.attempt == 1 ? 60.GB : 122.GB }
  }

  withName: '.*:GRIPSS_FILTERING:(?:GERMLINE|SOMATIC)' {
    queue = '{{_DOCKER_IMAGE_URI}}'
    cpus = 4
    memory = 30.GB
  }

  withName: '.*:SAGE_CALLING:GERMLINE' {
    queue = '{{SAGE_DOCKER_IMAGE_URI}}'
    cpus = 4
    memory = 30.GB
  }

  withName: '.*:SAGE_CALLING:SOMATIC' {
    queue = '{{SAGE_DOCKER_IMAGE_URI}}'
    cpus = 16
    memory = 30.GB
  }

  withName: '.*:SAGE_APPEND:(?:GERMLINE|SOMATIC)' {
    queue = '{{SAGE_DOCKER_IMAGE_URI}}'
    cpus = 2
    memory = 14.GB
  }

  withName: '.*:PAVE_ANNOTATION:GERMLINE' {
    queue = '{{PAVE_DOCKER_IMAGE_URI}}'
    cpus = 2
    memory = 14.GB
  }

  // NOTE(SW): PAVE somatic uses a significant amount of memory, runtime is usually less than 5-10 minutes

  withName: '.*:PAVE_ANNOTATION:SOMATIC' {
    queue = '{{PAVE_DOCKER_IMAGE_URI}}'
    cpus = 4
    memory = 30.GB
  }

  withName: 'PURPLE' {
    queue = '{{PURPLE_DOCKER_IMAGE_URI}}'

    errorStrategy = 'retry'
    maxRetries = 1

    cpus =   { task.attempt == 1 ? 4     : 8     }
    memory = { task.attempt == 1 ? 30.GB : 60.GB }
  }

  withName: '.*:LINX_ANNOTATION:(?:GERMLINE|SOMATIC)' {
    queue = '{{_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }

  withName: '.*:LINX_PLOTTING:VISUALISER' {
    queue = '{{_DOCKER_IMAGE_URI}}'
    errorStrategy = 'retry'
    maxRetries = 1

    cpus = 8
    memory = 60.GB
  }

  withName: '.*:LINX_PLOTTING:REPORT' {
    queue = '{{LINXREPORT_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }

  withName: 'BAMTOOLS' {
    queue = '{{BAMTOOLS_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 30.GB
    time = 24.h
  }

  withName: 'CHORD' {
    queue = '{{CHORD_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }

  withName: 'LILAC' {
    queue = '{{LILAC_DOCKER_IMAGE_URI}}'
    cpus = 4
    memory = 30.GB
  }

  withName: '.*:LILAC_CALLING:EXTRACTCONTIG' {
    queue = '{{LILAC_EXTRACT_INDEX_DOCKER_IMAGE_URI}}'
    cpus = 4
    memory = 30.GB
  }

  withName: '.*:LILAC_CALLING:REALIGNREADS' {
    queue = '{{LILAC_REALIGN_READS_DOCKER_IMAGE_URI}}'
    cpus = 4
    memory = 30.GB
  }

  withName: '.*:LILAC_CALLING:SLICEBAM' {
    queue = '{{LILAC_SLICE_DOCKER_IMAGE_URI}}'
    cpus = 4
    memory = 30.GB
  }

  withName: 'SIGS' {
    queue = '{{SIGS_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }

  withName: 'VIRUSBREAKEND' {
    queue = '{{VIRUSBREAKEND_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 60.GB
  }

  withName: 'VIRUSINTERPRETER' {
    queue = '{{VIRUSINTERPRETER_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }

  withName: 'ISOFOX' {
    queue = '{{ISOFOX_DOCKER_IMAGE_URI}}'
    cpus = 8
    memory = 30.GB
  }

  withName: 'CUPPA' {
    queue = '{{CUPPA_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }

  withName: 'ORANGE' {
    queue = '{{ORANGE_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }

  withName: 'CUSTOM_DUMPSOFTWAREVERSIONS' {
    queue = '{{DUMPSOFTWAREVERSIONS_DOCKER_IMAGE_URI}}'
    cpus = 1
    memory = 12.GB
  }
}
